kango.ui.BrowserButton=function(a){kango.ui.ButtonBase.call(this,a);this._buttonId="kango-ui-browserButton_"+kango.utils.getDomainFromId(kango.getExtensionInfo().id);this._icon=a.icon||"";this._caption=a.caption||"";this._tooltipText=a.tooltipText||null;this._popupDetails=a.popup||null;this._badgeText="";this._badgeBackgroundColor=this._badgeDefaultBackgroundColor;this._imageContent=this._image=null;this._popup=new kango.ui.Popup;this._popup.addEventListener("PopupDocumentComplete",kango.func.bind(this._onPopupDocumentComplete,
this));this.init()};
kango.ui.BrowserButton.prototype=kango.oop.extend(kango.ui.ButtonBase,{_buttonId:null,_icon:null,_caption:null,_tooltipText:null,_badgeBackgroundColor:null,_badgeDefaultBackgroundColor:[176,0,18,255],_badgeText:"",_popup:null,_popupDetails:null,_image:null,_imageContent:null,init:function(){kango.array.forEach(kango.chromeWindows.getLoadedChromeWindows(),function(a){this._insertButton(a)},this);kango.chromeWindows.addEventListener(kango.chromeWindows.event.WINDOW_LOAD,kango.func.bind(function(a){this._insertButton(a.window)},this));
kango.chromeWindows.addEventListener(kango.chromeWindows.event.WINDOW_UNLOAD,kango.func.bind(function(a){this._removeButton(a.window)},this))},dispose:function(){this.removeAllEventListeners();this._destroyImage();this._popup.close();this._popup=null;kango.array.forEach(kango.chromeWindows.getLoadedChromeWindows(),function(a){this._removeButton(a)},this)},_destroyImage:function(){null!=this._image&&(this._image.onload=function(){},this._image=null)},_getCanvas:function(){var a=kango.chromeWindows.getHiddenWindow(),
b="kango-ui-canvas_"+kango.utils.getDomainFromId(kango.getExtensionInfo().id),c=a.document.getElementById(b);null==c&&(c=a.document.createElementNS(XHTML_NS,"canvas"),c.setAttribute("id",b));return c},_getBackgroundColor:function(a){return"rgba("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]/255+")"},_removeButton:function(a){a=a.document.getElementById(this._buttonId);null!=a&&a.parentNode.removeChild(a)},_insertButton:function(a){var b=a.document,c=this._buttonId,d=b.createElement("toolbarbutton");d.setAttribute("id",
c);d.setAttribute("type","button");d.setAttribute("removable","true");d.setAttribute("class","toolbarbutton-1 chromeclass-toolbar-additional");d.setAttribute("label",this._caption);d.setAttribute("tooltiptext",this._tooltipText);d.setAttribute("image",this._imageContent||kango.io.getExtensionFileUrl(this._icon));var f=kango.func.bind(this._onCommand,this);d.addEventListener("command",f,!1);kango.chromeWindows.registerContainerUnloader(function(){d.removeEventListener("command",f,!1)},a);b.getElementById("navigator-toolbox").palette.appendChild(d);
a=b.getElementById("nav-bar");var e=a.getAttribute("currentset").split(","),g=e.indexOf(c);if(-1==g)null==kango.systemStorage.getItem("ui.button_inserted")&&(kango.systemStorage.setItem("ui.button_inserted",!0),a.insertItem(c),a.setAttribute("currentset",a.currentSet),b.persist(a.id,"currentset"));else{var l=null;g+1<e.length&&(l=b.getElementById(e[g+1]));null!=l?a.insertItem(c,l):a.insertItem(c)}return d},_getButtonElement:function(a){return a.document.getElementById(this._buttonId)},_onCommand:function(a){var b=
a.target;if(b.id==this._buttonId)if(null!=this._popupDetails){var c=b.getBoundingClientRect();a=parseInt(b.boxObject.screenX+c.width/2,10);b=parseInt(b.boxObject.screenY+c.height,10);this._popup.open({url:this._popupDetails.url,width:parseInt(this._popupDetails.width,10),height:parseInt(this._popupDetails.height,10),x:a,y:b})}else this.fireEvent(this.event.COMMAND)},_onPopupDocumentComplete:function(a){this.fireEvent(this.event.POPUP_DOCUMENT_COMPLETE,a)},_updateEachButtonImage:function(){this._updateImage(kango.func.bind(function(){this._forEachButton(kango.func.bind(function(a){a.image=
this._imageContent},this))},this))},_forEachButton:function(a){kango.array.forEach(kango.chromeWindows.getLoadedChromeWindows(),function(b){var c=this._getButtonElement(b);null!=c&&a(c,b)},this)},_updateImage:function(a){this._destroyImage();var b=this._image=new (kango.chromeWindows.getHiddenWindow().Image);b.onload=kango.func.bind(function(){var c=b.width,d=b.height;if(19<c||19<d)c=d=19;var f=this._getCanvas(),e=f.getContext("2d");if(""!=this._badgeText){e.font="bold 11px Tahoma,arial,helvetica,sans-serif";
f.width=19;f.height=19;var g=Math.round(e.measureText(this._badgeText).width);f.width=c+g+2;f.height=d;e.drawImage(b,0,0,c,d);var l=this._getBackgroundColor(this._badgeBackgroundColor),h=c+-4,k=d-11-1,g=g+6;e.beginPath();e.moveTo(h,k+4);e.lineTo(h,k+12-4);e.quadraticCurveTo(h,k+12,h+4,k+12);e.lineTo(h+g-4,k+12);e.quadraticCurveTo(h+g,k+12,h+g,k+12-4);e.lineTo(h+g,k+4);e.quadraticCurveTo(h+g,k,h+g-4,k);e.lineTo(h+4,k);e.quadraticCurveTo(h,k,h,k+4);e.fillStyle=l;e.fill();e.font="bold 11px Tahoma,arial,helvetica,sans-serif";
e.textBaseline="top";e.fillStyle="white";e.fillText(this._badgeText,c+-4+2,d-11)}else f.width=c,f.height=d,e.drawImage(b,0,0,c,d);this._imageContent=f.toDataURL("image/png");a()},this);b.src=kango.io.getExtensionFileUrl(this._icon)},_setTooltipText:function(a,b){a.setAttribute("tooltiptext",b)},_setCaption:function(a,b){a.label=b},_setContextMenu:function(a,b,c,d){b=b.document;var f=b.createElement("menupopup");f.setAttribute("id",a.id+"-menu");a.appendChild(f);b=b.createElement("menuitem");b.setAttribute("label",
c);b.addEventListener("command",function(a){d();a.preventDefault()},!1);f.appendChild(b);a.addEventListener("contextmenu",function(b){f.openPopup(a,"after_start",0,0,!0,!1);b.preventDefault()},!1)},setTooltipText:function(a){this._tooltipText=a;this._forEachButton(kango.func.bind(function(b){this._setTooltipText(b,a)},this))},setCaption:function(a){this._caption=a;this._forEachButton(kango.func.bind(function(b){this._setCaption(b,a)},this))},setIcon:function(a){""!=a&&null!=a?this._icon!=a&&(this._icon=
a,this._updateEachButtonImage()):this._forEachButton(kango.func.bind(function(a){a.removeAttribute("image")},this))},setBadgeValue:function(a){a=null!=a&&0!=a?a.toString():"";this._badgeText!=a&&(this._badgeText=a,this._updateEachButtonImage())},setBadgeBackgroundColor:function(a){null!=a&&(kango.object.isArray(a)&&4<=a.length)&&(this._badgeBackgroundColor=a,this._updateEachButtonImage())},setPopup:function(a){this._popupDetails=a},closePopup:function(){this._popup.close()},setContextMenu:function(a,
b){this._forEachButton(kango.func.bind(function(c,d){this._setContextMenu(c,d,a,b)},this))}});
